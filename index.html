<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="utf-8">
  <title>Windows log Viewer</title>
  <link rel="stylesheet" href="static/css/style.css">
</head>

<script language="javascript" type="text/javascript" src="./static/js/file_open.js"></script>
<script language="javascript" type="text/javascript" src="./static/js/library.js"></script>

<body>
  <div class="uploader">
    <input type="file" name="file" id="select-file" onchange="selectFile()" />
  </div>
  <hr>
  <table>
    <tr>
      <td> <a href="javascript:void(0);" id="output_btn" onclick="output()" class="btn_23">File Download</a>
      </td>
    </tr>
  </table>
  </a>
  <hr>
  <input type="text" id="searchText" />
  <input type="button" value="検索" id="searchBtn" />

  <script>
    initialize();
    function initialize() {
      const button = document.getElementById('searchBtn');
      const input = document.getElementById('searchText');
      input.addEventListener('keypress', () => {
        if (event.key === 'Enter') filterRows();
      });
      button.onclick = filterRows;
    }

    function filterRows() {
      const keyword = document.getElementById('searchText').value;
      const regex = new RegExp(keyword, 'i');
      const resultTable = document.getElementById("resultTable");
      for (let i = 0; i < resultTable.rows.length; i++) {
        const row = resultTable.rows[i];
        row.style.display = 'none';
        for (let j = 0; j < row.cells.length; j++) {
          if (row.cells[j].textContent.match(regex)) {
            row.style.display = 'table-row';
            break;
          }
        }
      }
    }
    // テーブルソート
    window.addEventListener('load', function () {
      let column_no = 0; //今回クリックされた列番号
      let column_no_prev = 0; //前回クリックされた列番号
      document.querySelectorAll('#dataTable th').forEach(elm => {
        elm.onclick = function () {
          column_no = this.cellIndex; //クリックされた列番号
          let table = this.parentNode.parentNode.parentNode;
          let sortType = 0; //0:数値 1:文字
          let sortArray = new Array; //クリックした列のデータを全て格納する配列
          for (let r = 1; r < table.rows.length; r++) {
            //行番号と値を配列に格納
            let column = new Object;
            column.row = table.rows[r];
            column.value = table.rows[r].cells[column_no].textContent;
            sortArray.push(column);
            //数値判定
            if (isNaN(Number(column.value))) {
              sortType = 1; //値が数値変換できなかった場合は文字列ソート
            }
          }
          // TODO: 日付でソートが未実装
          if (sortType == 0) { //数値ソート
            if (column_no_prev == column_no) { //同じ列が2回クリックされた場合は降順ソート
              sortArray.sort(compareNumberDesc);
            } else {
              sortArray.sort(compareNumber);
            }
          } else { //文字列ソート
            if (column_no_prev == column_no) { //同じ列が2回クリックされた場合は降順ソート
              sortArray.sort(compareStringDesc);
            } else {
              sortArray.sort(compareString);
            }
          }
/*
          //ソート後のTRオブジェクトを順番にtbodyへ追加（移動）
          var result_data = [];
          for (let i = 0; i < sortArray.length; i++) {
            result_data.push(sortArray[i].row.outerText.replace(/\t/g, ",").split(/,/))
          }
          console.log(result_data)
          clearTable();
          createTable(result_data);
*/
          const resultTable = document.getElementById("resultTable");
          let tbody = this.parentNode.parentNode;
          for (let i = 0; i < sortArray.length; i++) {
            resultTable.appendChild(sortArray[i].row);
          }
          //昇順／降順ソート切り替えのために列番号を保存
          if (column_no_prev == column_no) {
            column_no_prev = -1; //降順ソート
          } else {
            column_no_prev = column_no;
          }
        };
      });
    });

  </script>

  <table class="content-table" id="dataTable">
    <thead>
      <tr>
        <th width="5%">No</th>
        <th width="5%">レベル</th>
        <th width="15%">日付</th>
        <th width="15%">ソース</th>
        <th width="8%">イベントID</th>
        <th width="10%">タスクのカテゴリ</th>
        <th>詳細</th>
      </tr>
    </thead>
    <tbody id="resultTable"></tbody> <!-- ここに配列の中身を表示させる -->
  </table>
</body>

</html>